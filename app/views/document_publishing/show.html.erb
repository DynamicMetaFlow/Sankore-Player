<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Uniboard player</title>
	
	<style type="text/css">
	  @import url(/uniboard-player/stylesheets/reset.css);
	  @import url(/uniboard-player/stylesheets/master.css);
	</style>
	
	<!-- Libraries -->
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/uniboard-player/scripts/jquery-ui-1.8rc3.custom.min.js"></script>
  <script type="text/javascript" src="/uniboard-player/scripts/jquery.easing.1.3.js"></script>
	
	<script type="text/javascript">
	  
	  (function($) {
	  
  	  var thumbsBar = { state:"min", fullHeightVal:100, minHeightVal:0, sliding:false };
  	  var currentPage = { number:1, width:0, height:0 };
  	  var state = "full";
  	  var adaptPageTimer = null;
  	  var sliderTimer = null;
  	  var numberOfPages = <%= @published_document.page_count %>;
  	  var pagesBaseUrl =  '<%= @published_document.persistence_url %>';
  	  var description = "<a href='mailto:rafi'>Rafi Najakalahr Fakha</a> <br/>06 Jun 2009<br/> <b>One, two, three, four</b> <br/><br/> Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin vel mattis lorem. Mauris porttitor neque quis velit consectetur mattis. Morbi et quam lorem, sed interdum augue. Aliquam pellentesque, arcu ac tincidunt varius, urna eros tristique erat, ut lacinia velit nisi at ante. Integer magna lorem, semper eu sodales quis, dapibus sed neque. Etiam non ligula quis nisi dapibus volutpat. Morbi vitae sollicitudin massa. Praesent mattis fringilla nunc, quis ultricies dolor elementum ut. Aliquam tincidunt porta interdum. Etiam vitae malesuada elit." // ! \\
	  	  
  	  $(document).ready(function(){
	      
	      // bind the buttons events
  	    $("#menu-button-previous").click(function(){ goToPage("PREVIOUS") });
  	    $("#menu-button-index").toggle(function(){ showIndex() }, function(){ hideIndex() });
  	    $("#menu-button-next").click(function(){ goToPage("NEXT") });
        $("#board-button-previous").click(function(){ goToPage("PREVIOUS") });
  	    $("#board-button-next").click(function(){ goToPage("NEXT") });
  	    $("#board-button-last").click(function(){ goToPage(numberOfPages) });
  	    $("#board-button-first").click(function(){ goToPage(1) });
	      $(".board-button")
	        .mouseenter(function(){$(this).animate({opacity:1})})
	        .mouseout(function(){$(this).animate({opacity:0})});
	      $("#menubottom-input").change(function(){ goToPage($("#menubottom-input").val()) });
	      $("#moreLink").toggle(function(){showDescription()}, function(){hideDescription()});
	      $("#menu-button-export")
	        .toggle(
	          function(){ $("#menu-export-dropdown").show() },
	          function(){ $("#menu-export-dropdown").hide() })
	        .hover(
	          function(){ $("#menu-button-export-left").css("background", "url(/uniboard-player/images/menu-button-export-left-over.png)") },
	          function(){ $("#menu-button-export-left").css("background", "url(/uniboard-player/images/menu-button-export-left.png)") });
	      $("#menu-button-full").click(function(){ 
	        $("#logo-uniboard").hide();
	        $("#document-title").hide();
	        $("#head-button-close").show();
	        $("#head").css({height:40});
	        $("#foot").hide();
	        $("#body").css({paddingTop:40, paddingBottom:40});
	        $(window).resize();
	      });
  	    $("#menu-button-showthumbnails").click(function(){
    	    var newFootHeight = 0;
  	    
    	    if(thumbsBar.state === "min"){
    	      $(".thumbnail").css("display", "inline-block");
    	      newFootHeight = thumbsBar.fullHeightVal;
    	      thumbsBar.state = "full";
  	      } else {
  	        $(".thumbnail").css("display", "none");
  	        newFootHeight = thumbsBar.minHeightVal;
  	        thumbsBar.state = "min";
          }
    	    
    	    $("#body").css({paddingBottom:110 + newFootHeight });
    	    $("#thumbnails").animate(
    	      {height:32 + newFootHeight},
  	        400,
  	        "easeOutBack"
  	      );
    	    $("#foot").animate(
    	      {height:84 + newFootHeight, marginTop:-84 -newFootHeight -12},
    	      400,
    	      "easeOutBack"
    	    );
    	    
    	    $(window).resize();
    	  });
  	  
    	  // Constructs the slider
    	  var sliderPage = $("#thumbnails-slider>div:first").clone();
    	  var sliderPageWidth = (100/numberOfPages) + "%";
    	  $("#thumbnails-slider>div:first").remove();
    	  for(var i=1; i<=numberOfPages; i++){
    	    var newSliderPage = sliderPage.clone();
    	    newSliderPage
    	      .css({ width:sliderPageWidth })
    	      .click(function(){
    	        goToPage($(this).index()+1);
    	      });
    	    if(i===numberOfPages) newSliderPage.addClass("last");
    	    $("#thumbnails-slider").append(newSliderPage);
  	    }
  	    
  	    // Slider handler
  	    $("#thumbnails-slider>div:first").append($("#thumbnails-slider-handler"));
  	    $("#thumbnails-slider-handler").draggable({
  	      axis: 'x',
  	      containment:[ $("#thumbnails-slider>div:first-child").offset().left, 0, 
  	                    $("#thumbnails-slider>div:first-child").offset().left + $("#thumbnails-slider>div:first-child").width()*numberOfPages-20, 0  ],
  	      start:function(e){
  	        $(this).css({left:"0"});
  	        $(this).parent("div").css({zIndex:1});
  	        sliderListener(currentPage.number);
  	        thumbsBar.sliding = true;
  	      },
  	      stop:function(e){
  	        $(this).css({left:"0"});
  	        clearTimeout(sliderTimer);
  	        $(this).appendTo($("#thumbnails-slider>div")[currentPage.number-1]);
  	        thumbsBar.sliding = false;
  	      } 
  	    });
  	    
  	    // Add the thumbnails
  	    var newThumbnail = null;
  	    var formattedThumbNumber = null;
  	    for(var i=0; i<numberOfPages; i++){
  	      newThumbnail = $("#thumbnails>.thumbnail:first").clone();
  	      formattedThumbNumber = formatPageNumber(i+1);
  	      newThumbnail.find("img").attr("src", pagesBaseUrl + "/page" + formattedThumbNumber + ".thumbnail.jpg");
  	      $("#thumbnails>div:last-child").before(newThumbnail); 
  	    }
  	    $("#thumbnails>.thumbnail:first").remove();
  	    
  	    $(".thumbnail")
	        .hover(
	          function(){ $(this).addClass("current") },
	          function(){ $(this).removeClass("current") })
	        .click(function(){
	          goToPage($(this).index()-1);
	        });
  	    
  	    $(".board-button").animate({opacity: 0}, 1000);
  	    $("#description-text").append(description);
  	    $("#menubottom-input").after("/" + numberOfPages);
  	    openPage(1);
  	  });
	  
	    function sliderListener(currentPageNmbr){
	      var slider = $("#thumbnails-slider-handler");
	      var unitWidth = slider.parent("div").width();
	      var sliderIndex = 1 + Math.floor((slider.position().left + ((currentPageNmbr-1) * unitWidth)) / unitWidth);	      
	      if(sliderIndex !== currentPage.number) goToPage(sliderIndex);
	      sliderTimer = setTimeout(function(){sliderListener(currentPageNmbr)}, 10);
	    }
	  
  	  function goToPage(pageNumber){
  	    var checkPoint = { finish:"%", start:"%" };
	    
  	    if(pageNumber === "NEXT"){
  	      currentPage.number++;
  	      checkPoint = { finish:"-200%", start:"100%" };
  	    }else if(pageNumber === "PREVIOUS"){
  	      currentPage.number--;
  	      checkPoint = { finish:"100%", start:"-200%" };
  	    }else{
  	      if(pageNumber > currentPage.number){
  	        checkPoint = { finish:"-200%", start:"100%" };
  	      }else if(pageNumber < currentPage.number){
  	        checkPoint = { finish:"100%", start:"-200%" };
	        }else{
	          return 0;
          }
  	      currentPage.number = pageNumber;
  	    }
	    
  	    if(currentPage.number <= 0){
  	      currentPage.number = numberOfPages;
  	    }else if(currentPage.number > numberOfPages){
  	      currentPage.number = 1;
  	    }
	    	
        $("#board-current").animate(
          {marginLeft:checkPoint.finish},
          300,
          "easeInQuint",
          function(){
    	    	$("#thumbnails").css({width: $("#thumbnails").width()});
            $("#board-current").css({ marginLeft:checkPoint.start });
            openPage(currentPage.number);
            $("#board-current").animate(
              {marginLeft:"0"},
              300,
              "easeOutQuint",
              function(){
                $("#thumbnails").css({width: "100%"});
              }
            );
          }
        );
  	  }
	  
  	  function adaptPage(){
  	    $(window).resize();
  	    adaptPageTimer = setTimeout(function(){adaptPage()}, 10);
  	  }
  	  
  	  function formatPageNumber(pageNumber){
  	    var formattedPageNumber = ("00" + pageNumber).substr(("00" + pageNumber).length-3, 3);
  	    return formattedPageNumber;
  	  }
	  
      function openPage(pageNumber){
        var formattedPageNumber = formatPageNumber(pageNumber);
        var fileName = pagesBaseUrl + "/page" + formattedPageNumber + ".svg";
        currentPage.number = pageNumber;
        /*$.ajax({ 
          url: fileName,
          dataType: 'xml',
          success: function(data){
            currentPage.width = $(data).find("rect").attr("width");
            currentPage.height = $(data).find("rect").attr("height");*/
            $("#current-page").attr("src", fileName);
            $("#menubottom-input").val(pageNumber);
            $("#thumbnails-slider>div").removeClass("current");
            $($("#thumbnails-slider>div")[pageNumber-1]).addClass("current");
            if(!thumbsBar.sliding)$("#thumbnails-slider-handler").appendTo($("#thumbnails-slider>div")[pageNumber-1]);
            $(window).resize();
          /*}
        });*/
      }
	
		  function showDescription(){
  	    $("#boards").animate({marginTop:"100%"}, function(){
  	      $("#boards").hide();
  	      $("#document-title").hide();
  	      $("#head-button-close").show();
  	      $("#description").show();
  	    });
  	  }
  	  
  	  function hideDescription(){
  	    $("#boards").animate({marginTop:"0"}, function(){
  	      $("#boards").show();
  	      $("#document-title").show();
  	      $("#head-button-close").hide();
  	      $("#description").hide();
  	    });
  	  }
	
  	  function showIndex(){
  	    var thumbsPerRow = Math.round(Math.sqrt(numberOfPages));
  	    $("#boards").animate({marginTop:"-100%"}, function(){
  	      $("#boards").hide();
  	      $("#index")
    	      .show()
    	      .empty();
    	    drawIndexThumbnails(thumbsPerRow);
  	    });
  	  }
	  
  	  function hideIndex(){
  	    $("#index").hide();
  	    $("#boards").show();
        $("#thumbnails").show();
        $("#boards").animate({marginTop:"0"});
    	  $("#thumbnails").animate({marginTop:"0"});
  	  }
	  
  	  function drawIndexThumbnails(thumbsPerRow){
  	    var newIndex = $("#index>div").length + 1;
  	    var newIndexThumbnailNumber = formatPageNumber(newIndex);
  	    var newIndexThumbnail = $("<div class='thumbnail index'><img src='" + pagesBaseUrl + "/page" + 
  	                            newIndexThumbnailNumber + 
  	                            ".thumbnail.jpg' width='auto' height='100%'/></div>");
  	    newIndexThumbnail
  	      .hover(
	          function(){ $(this).addClass("current") },
	          function(){ $(this).removeClass("current") })
	        .click(function(){
	          openPage(newIndex);
	          $("#menu-button-index").click();
	        });
  	    $("#index").append(newIndexThumbnail);
  	    if((newIndex)%thumbsPerRow === 0)$("#index").append("<br/>");
  	    if($("#index>div").length < numberOfPages) setTimeout(function(){drawIndexThumbnails(thumbsPerRow)}, 100);
  	  }
	
  	  $(window).resize(function(){
  	    var ratioWh = 1.66;//currentPage.width / currentPage.height;
  	    $(".page").width($(".page").height() * ratioWh);
  	    $("#document-title").width($(".page").width());
  	    if($(window).height() < 500){
  	      state = "mini";
  	    }
  	  });
	  
  })(jQuery);
  
	</script>
	
</head>

<body>

  <div id="head">
    <div id="logo-uniboard"></div>
    <div id="document-title">
      <ul>
        <li>One, two, three, four<span>, 06 Jun 2009</span></li>
        <li>Rafi Najakalahr Fakha</li>
        <li><a id="moreLink" href="#">more…</a></li>
      </ul>
    </div>
    <div class="menu-button" id="head-button-close"></div>
  </div>

  <div id="body">
    <div id="boards">
      <div class="board" id="board-current">
        <div class="board-button">
          <div class="board-button-unit" id="board-button-previous"></div>
          <div class="board-button-unit" id="board-button-first"></div>
        </div>
        <iframe class="page" id="current-page" src=""></iframe>
        <div class="board-button">
          <div class="board-button-unit" id="board-button-next"></div>
          <div class="board-button-unit" id="board-button-last"></div>
        </div>
      </div>
    </div><!--boards-->
    <div id="index">
    </div><!--index-->
    <div id="description">
      <div id="description-text"></div>
    </div><!--description-->
  </div>

  <div id="foot">
    <div style="position:relative; height:100%; margin-left:50px; margin-right:50px">
   <div id="thumbnails">
      <div id="thumbnails-slider-handler"></div>
      <div id="thumbnails-slider"><div class="thumbnails-slider-page"></div></div>
      <div style="width:14px; height:80px; position:absolute; top:45px; left:0px; color:red; font-size:10px; line-height:80px; text-decoration:underline; letter-spacing:normal">1</div>
      <div class="thumbnail"><img src="" alt="thumbnail" height="100%" width="auto"/></div>
      <div style="width:18px; height:80px; position:absolute; top:45px; left:100%; margin-left:-18px; color:red; font-size:10px; line-height:80px; text-decoration:underline; letter-spacing:normal">4</div>
    </div><!--thumbnails-->
    <div class="menu bottom">
      <div class="menu-box-left menu-box">
        <div class="menu-button" id="menu-button-showthumbnails"></div>
        <div style="display:block; float:left; height:31px; margin-left:10px; line-height:42px"><input id="menubottom-input" type="text"></div>
      </div>
      <div class="menu-box-center menu-box">
        <div class="menu-button" id="menu-button-previous"></div>
        <div class="menu-button" id="menu-button-index"></div>
        <div class="menu-button" id="menu-button-next"></div>
      </div>
      <div class="menu-box-right menu-box">
        <div class="menu-button" id="menu-button-full"></div>
        <div class="menu-button" id="menu-button-export">
          <div id="menu-button-export-left"></div>
          <div id="menu-button-export-center">Export as…</div>
          <div id="menu-button-export-right"></div>
        </div>
        <div id="menu-export-dropdown"><ul><li>.PDF</li><li>.UBZ</li></ul></div>
      </div>
    </div>
    </div>
  </div>

</body>
</html>
